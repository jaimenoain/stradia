# AI Status

## Core Framework Versions
- **Next.js**: 15.5.12
- **React**: 19.2.4
- **TypeScript**: ^5

## Tooling Setup
- **ESLint**: Configured and active.
- **Prettier**: Configured with standard settings.
- **Strict Mode**: Enabled in `tsconfig.json`.

## Context Packing (Repomix)
- **Configuration**: `repomix.config.json` established with strict output settings (XML, line numbers, no empty lines).
- **Prioritization**: `.ai-status.md` is pinned as instructions. Documentation files (`docs/*`) are included in standard alphabetical order.

## Documentation
- **Task 0.2: Ground Truth Documentation** successfully seeded and verified.
    - `ARCHITECTURE.md`
    - `FUNCTIONAL_SPEC.md`
    - `DOMAIN_MODEL.md`
    - `UX_SPEC.md`
    - `API_CONTRACT.md`

## Design System Status
- **Design Tokens**: Configured in `app/globals.css` and `tailwind.config.ts`.
    - **Colors**: HSL variables (background, foreground, primary, secondary, accent, destructive, success, warning, etc.).
    - **Typography**: `var(--font-sans)` with fallback to Inter and sans-serif.
- **Components (Shadcn/UI)**:
    - `button`
    - `input`
    - `card`
    - `alert`
    - `toast`
    - `toaster`
    - `table`
    - `resizable`

## Current Architecture Snapshot

### 1. Routing Topology (Next.js App Router)
The application uses Route Groups to enforce layout boundaries:
- **`app/(marketing)`**: Public landing pages.
- **`app/(auth)`**: Authentication flows (Login), using a centered card layout.
- **`app/(dashboard)`**: Authenticated views (Overview, Strategies, Settings, Boards), using a persistent Sidebar + TopNav layout.

**Verified Routes:**
- `/` -> Marketing Home
- `/login` -> Login Page
- `/overview` -> Global Dashboard
- `/strategies` -> Strategy Builder
- `/settings` -> Settings
- `/markets/[marketId]/board` -> Local Kanban Board

### 2. Global Providers (`app/providers.tsx`)
All client-side context providers are wrapped in `app/layout.tsx`:
- **`NextThemesProvider`**: Handles light/dark mode.
- **`QueryClientProvider`**: Mock implementation (placeholder for TanStack Query).
- **`AuthProvider`**: React Context managing `user` state and `login/logout` methods.
- **`MockSessionProvider`**: Automatically hydrates `useSessionStore` with a `GLOBAL_ADMIN` user when `NEXT_PUBLIC_USE_MOCKS=true`.

### 3. State Management Strategy
- **Session State**: Managed via **Zustand** (`lib/stores/session-store.ts`) for global access.
- **Auth State**: Managed via **React Context** (`lib/auth/provider.tsx`) for component lifecycle integration.
- **Data Fetching**: Abstrated via `lib/api-client.ts` which toggles between `fetch` and `MockApiClient`.

### 4. Database Layer (Prisma Schema)
- **Tenant**: Multi-tenancy root with AI Token Quota enforcement.
- **User**: Authenticated entity belonging to a Tenant (RBAC via `UserRole`).
- **Market**: Business context for Strategies and localized data (`region_code`, `timezone`).
- **UserMarket**: Join table for User-Market access permissions.

### 5. Database Security & Performance
- **Row Level Security (RLS)**: Strictly ENABLED with a Default Deny posture on `Tenant`, `User`, `Market`, and `UserMarket`.
- **Indexing Strategy**: Database indexes have been successfully created for `tenant_id`, `user_id`, and `market_id`.
- **Secure Functions**: The `get_jwt_tenant_id()` secure database function has been established for future policies.

### 6. Database Security (Implemented)
- **Strict Tenant Isolation**: Enforced via RLS policies on `Tenant`, `User`, `Market`, and `UserMarket` tables using `tenant_id = (auth.jwt() ->> 'tenant_id')::uuid`.
- **Role-Based Market Visibility**:
    - **Global Admin**: Full visibility of all markets within their tenant.
    - **Local User / Supervisor**: Strict visibility limitation to assigned markets via `UserMarket` junction table.
- **Verification**: Validated via `verify_rls_policies.ts` using PGlite simulation with positive/negative assertions for multiple roles.

## Current Phase Status
- **Phase 1: The Walking Skeleton**: **COMPLETE**
- **Phase 2: Database & Data Modeling**: **COMPLETE**
  - **Task 2.1: Prisma ORM initialization and connection strategy**: **COMPLETE**
  - **Task 2.2: Core multi-tenant Prisma schema defined successfully.**
  - **Task 2.3: Database Migration & Client Generation**: Database schema successfully pushed to Supabase. Prisma Client generated and Singleton established at `lib/prisma.ts`.
  - **Task 2.4: RLS Verification Script**: **COMPLETE**. Enhanced `verify_rls_default_deny.ts` to support dual-mode verification (Live vs PGlite offline) to strictly validate Default Deny policy on Tenant, User, Market, and UserMarket tables.
  - **Task 2.5: Database Hardening**: RLS enabled, Indexes created, and Helper functions deployed.
  - **Task 2.6: RLS Policies Implementation**: **COMPLETE**. Implemented strict RLS policies for Tenant Isolation and Market Visibility (Global Admin override vs Local User assignment). Verified with `verify_rls_policies.ts`.
  - **Task 2.97: Automated QA & Logic Verification**: **COMPLETE**. Reconciled TypeScript mocks with generated Prisma Client types.
  - **Task 2.98: User Acceptance Testing (Manual Validation)**: **COMPLETE**. Confirmed manual validation of database schema, RLS policies, and tenant isolation within Supabase Dashboard.
  - **Task 2.99: Phase 2 Documentation & Status Update**: **COMPLETE**. Verified domain model alignment and updated status log.
- **Status**: Phase 2 Complete. Database architecture and RLS security layer fully implemented and verified.

## Verification Status (Latest - Task 2.99)
- **Timestamp**: 2025-05-23
- **TypeScript**: Pass (npx tsc --noEmit)
- **Linting**: Pass (npm run lint)
- **Issues Logged**: Reconciled `UserRole` enum in `lib/auth/types.ts` to use `@prisma/client`. Updated `MockSessionUser` to strictly `Pick<User, ...>` from `@prisma/client`. No incurred debt.
